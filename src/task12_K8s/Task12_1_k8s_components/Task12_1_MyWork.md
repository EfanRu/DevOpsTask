# Домашнее задание к занятию «Компоненты Kubernetes»

### Цель задания

Рассчитать требования к кластеру под проект

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания:

- [Considerations for large clusters](https://kubernetes.io/docs/setup/best-practices/cluster-large/),
- [Architecting Kubernetes clusters — choosing a worker node size](https://learnk8s.io/kubernetes-node-size).

------

### Задание. Необходимо определить требуемые ресурсы
Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения. 
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий. 
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.

------

### Решение. Требуемые ресурсы

#### Первоначальный расчет по основным компонентам

    Из требований к приложению у нас должны быть отказоустойчивые БД и Кеш, а так же их нужно по 3 копии.
    Чтобы добиться отказоустойчивости нужно размещать копии сервисов (БД, Кеш и т.п.) не только в разных нодах, 
    но и на разных серверах, желательно в разных дата центрах. Так как разместить все 3 ноды БД и Кэш на 1 сервере 
    было бы глупо, нет доступности сервера - нет доступности всего приложения. Но это не учитывается в задании, так что 
    будем рассчитывать отдельные ноды.
    То есть нам нужно 3 worker ноды под БД и Кеш, каждый из которых потребляет 8 Gb RAM и 2 CPU + русурсы ОС (700 Mb и 0.5 CPU).
    Если обновление pods идет по стратегии rolling (в задании это не уточняется, так что будем использовать ее), 
    то нужно будет ресурсов на ещё один под, так как при обновлении pod будет создан сначала новый pod без уничтожения 
    старого.

    Нам потребуется 3 master ноды, которые потребляют 2 Gb RAM и 1.5 CPU.

- [Kublr_Kubernetes_Cluster_Requirements](https://docs.kublr.com/installation/hardware-recommendation/).

------

#### Предварительный подитог по важным и отказоустойчивым компонентам:
    3 worker ноды, каждый из которых потребляет 12.7 Gb RAM и 2.5 CPU.
    3 master ноды, каждый из которых потребляет 2 Gb RAM и 1.5 CPU.
    
------

#### Расчет всех остальных компонентов

    Backend и frontend распределим между 3 worker нодами, и рассчитаем максимально загруженную ноду с учетом, 
    что pods распределяются по нагрузке и все 10 копий backend не окажутся на 1 ноде, а 10 / 3 = 3 + 1 в остатке.
    Итого: + 2650 Mb RAM + 2.02 CPU

------

#### Предварительный итог по всем компонентам:
    3 worker ноды, каждый из которых потребляет 15.3 Gb RAM и 7.3 CPU.
    3 master ноды, каждый из которых потребляет 2 Gb RAM и 1.5 CPU.
    
------

#### Разделение на более мелкие ноды
    Так как 3 worker ноды по 15.3 Gb RAM и 7.3 CPU при выходе из строя 1 ноды из строя просто не справятся с возросшей 
    нагрузкой, то лучшим вариантом будет увеличить их до 6 worker нод и распределить их по группам следующим образом:
    На каждой ноде будет 1 копия "жирного" пода (БД или КЕШ) + мелкие + место на ещё один "жирный" под для его обновления 
    или присоединения под с упавшей ноды.

    Итого по жирным подам под БД или Кеш + для наката нового пода х2 по ресурсам: 8 Gb RAM и 2 CPU;

    Backend и frontend распределим между 6 worker нодами, и рассчитаем максимально загруженную ноду с учетом, 
    что pods распределяются по нагрузке и все 10 копий backend не окажутся на 1 ноде, а 10 / 6 = 1 + 4 в остатке.
    Запас под пересоздание pod по стратегии rolling тут не считаем, так как он учтен для "жирных" pods.
    Frontrnd по 1 копии на 5 из 6 нод.

    Итого по малым подам: + 1200 Mb RAM + 4.8 CPU

    Итого: 6 worker нод по 9.2 Gb RAM и 6.8 CPU.

    Выводы по сравнению с 3 worker нодами: 
        3 woker ноды по 15.3 Gb RAM и 7.3 CPU суммарно получаются на: 45.9 Gb RAM и 21.9
        6 woker ноды по 9.2 Gb RAM и 6.8 CPU суммарно получаются на: 55.2 Gb RAM и 40.8 CPU
    Для варианта с 3 worker нодами получается экономия по CPU, но при выходе одной из нод не остальные не выдержат нагрузку.
    Следовательно, нужно выбрать вариант с 6 worker нодами, хотя из-за очень "жирных" подов они тратят больше ресурсов.

------

#### Предварительный итог после разделения на мелкие ноды:
    
    6 worker нод по 9.2 Gb RAM и 6.8 CPU.
    3 master ноды, каждый из которых потребляет 2 Gb RAM и 1.5 CPU.

------

#### Резервирование

    Учтем резервирование CPU:
        6% для первого ядра.
        1% для следующего ядра (2 всего).
        0.5% для следующих двух (4 всего).
        0.25% для следующих.

    Для worker 6.8 ~ 7 ядер. А это значит нужно прибавить к ним + 8.75 %. И получаем ~ 7.395 ядер.
    Для master 1.5 ~ 2 ядер. А это значит нужно прибавить к ним + 7 %. И получаем ~ 1.605 ядер.

    Для памяти это выглядит так:
    
        255 Мб памяти для компьютеров с объемом памяти менее 1 ГБ.
        25% от первых 4 ГБ памяти.
        20% от следующих 4 ГБ памяти (до 8 ГБ).
        10% от следующих 8 ГБ памяти (до 16 ГБ).
        6% от следующих 112 ГБ памяти (до 128 ГБ).
        2% от любой памяти объемом свыше 128 ГБ.

    Для worker 9.2 Gb RAM. А это значит нужно прибавить к ним + 1 + 0.8 + 0.12 = 1.92 %. И получаем ~ 9.37 Gb
    Для master 2 Gb RAM. А это значит нужно прибавить к ним + 1 %. И получаем ~ 2.02 Gb

------

#### Итог по всем компонентам + резервиврование:
    6 worker нод по 9.37 Gb RAM и 7.395 CPU.
    3 master ноды, каждый из которых потребляет 2.02 Gb RAM и 1.605 CPU.

    Рассчет ресурсов опирался на архитектуру, когда у нас для каждого "жирного" пода выделена своя нода, куда в случае 
    выхода из строя одной из нод может поместиться ещё один "жирный" под. Правда тогда не останется места для его обновления, 
    но зато система продолжить работать и теоритически убив под руками и переинов на другую ноду, можно и его обновить.
    Мастер ноды в количестве 3 штук для резервирования + на них больше ничего не работает.
    
------



----

### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Сначала сделайте расчёт всех необходимых ресурсов.
3. Затем прикиньте количество рабочих нод, которые справятся с такой нагрузкой.
4. Добавьте к полученным цифрам запас, который учитывает выход из строя как минимум одной ноды. 
5. Добавьте служебные ресурсы к нодам. Помните, что для разных типов нод требовния к ресурсам разные. 
6. В результате должно быть указано количество нод и их параметры.

