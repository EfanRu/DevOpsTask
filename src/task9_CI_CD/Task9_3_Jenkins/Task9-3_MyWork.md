# Домашнее задание к занятию 10 «Jenkins»

## Подготовка к выполнению

### Задание 1
   Создать два VM: для jenkins-master и jenkins-agent.

### Решение 1
    Сделано.

### Задание 2
    Установить Jenkins при помощи playbook.

### Решение 2

<details><summary>Вывод в консоль:</summary>

```commandline
ansible-playbook -i ./inventory/cicd/hosts.yml ./site.yml 

PLAY [Preapre all hosts] ********************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************
The authenticity of host '158.160.62.250 (158.160.62.250)' can't be established.
ED25519 key fingerprint is SHA256:92sZv+IORIY4NfRmsAgwE06xDbhmOYLQHEF7I1h1crM.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? ok: [jenkins-master-01]
yes
ok: [jenkins-agent-01]

TASK [Create group] *************************************************************************************************************************************************************
ok: [jenkins-master-01]
ok: [jenkins-agent-01]

TASK [Create user] **************************************************************************************************************************************************************
ok: [jenkins-master-01]
changed: [jenkins-agent-01]

TASK [Install JDK] **************************************************************************************************************************************************************
ok: [jenkins-master-01]
changed: [jenkins-agent-01]

PLAY [Get Jenkins master installed] *********************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************
ok: [jenkins-master-01]

TASK [Get repo Jenkins] *********************************************************************************************************************************************************
ok: [jenkins-master-01]

TASK [Add Jenkins key] **********************************************************************************************************************************************************
ok: [jenkins-master-01]

TASK [Install epel-release] *****************************************************************************************************************************************************
ok: [jenkins-master-01]

TASK [Install Jenkins and requirements] *****************************************************************************************************************************************
ok: [jenkins-master-01]

TASK [Ensure jenkins agents are present in known_hosts file] ********************************************************************************************************************
# 158.160.62.250:22 SSH-2.0-OpenSSH_7.4
# 158.160.62.250:22 SSH-2.0-OpenSSH_7.4
# 158.160.62.250:22 SSH-2.0-OpenSSH_7.4
# 158.160.62.250:22 SSH-2.0-OpenSSH_7.4
# 158.160.62.250:22 SSH-2.0-OpenSSH_7.4
changed: [jenkins-master-01] => (item=jenkins-agent-01)

TASK [Start Jenkins] ************************************************************************************************************************************************************
skipping: [jenkins-master-01]

PLAY [Prepare jenkins agent] ****************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************
ok: [jenkins-agent-01]

TASK [Create agent_dir] *********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Add docker repo] **********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Install some required] ****************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Update pip] ***************************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Install Ansible] **********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Reinstall Selinux] ********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Add local to PATH] ********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Create docker group] ******************************************************************************************************************************************************
ok: [jenkins-agent-01]

TASK [Add jenkinsuser to dockergroup] *******************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Restart docker] ***********************************************************************************************************************************************************
changed: [jenkins-agent-01]

TASK [Install agent.jar] ********************************************************************************************************************************************************
changed: [jenkins-agent-01]

PLAY RECAP **********************************************************************************************************************************************************************
jenkins-agent-01           : ok=16   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
jenkins-master-01          : ok=10   changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

```

</details>


### Задание 3
    Запустить и проверить работоспособность.

### Решение 3
![Start jenkins.png](Screenshoots%2FStart%20jenkins.png)

### Задание 4
    Сделать первоначальную настройку.

### Решение 4
![Run jenkis with agent.png](Screenshoots%2FRun%20jenkis%20with%20agent.png)    


## Основная часть

### Задание 1
    Сделать Freestyle Job, который будет запускать molecule test из любого вашего репозитория с ролью.

### Решение 1
    Сделать freestyle job получилось, но не смог подружить molecule и версией Python.
![My freestyle job.png](Screenshoots%2FMy%20freestyle%20job.png)

### Задание 2
    Сделать Declarative Pipeline Job, который будет запускать molecule test из любого вашего репозитория с ролью.

### Решение 2
    Сделал Declarative pipeline, но так же как и в прошлом шаге не победил molecule и версией Python.
![Declarative pipeline.png](Screenshoots%2FDeclarative%20pipeline.png)

### Задание 3
    Перенести Declarative Pipeline в репозиторий в файл Jenkinsfile.

### Решение 3
    Сделано.
[Jenkinsfile](pipeline%2FJenkinsfile)

### Задание 4
    Создать Multibranch Pipeline на запуск Jenkinsfile из репозитория.

### Решение 4
    Добавил файл Jenkinsfile в репозиторий и вычитываю из него
![Multibranch pipeline.png](Screenshoots%2FMultibranch%20pipeline.png)

### Задание 5
    Создать Scripted Pipeline, наполнить его скриптом из pipeline.

### Решение 5
![Scripted.png](Screenshoots%2FScripted.png)

### Задание 6
    Внести необходимые изменения, чтобы Pipeline запускал ansible-playbook без флагов --check --diff, если не установлен 
    параметр при запуске джобы (prod_run = True). По умолчанию параметр имеет значение False и запускает прогон 
    с флагами --check --diff.

### Решение 6
    Сделано. Параметр добавлен в pipe и выставляется при запуске сборки.
[ScriptedJenkinsfile](pipeline%2FScriptedJenkinsfile)
![Scripted with param.png](Screenshoots%2FScripted%20with%20param.png)

### Задание 7
    Проверить работоспособность, исправить ошибки, исправленный Pipeline вложить в репозиторий в файл ScriptedJenkinsfile.

### Решение 7
    Все проходит.
![Scripted with param success.png](Screenshoots%2FScripted%20with%20param%20success.png)

### Задание 8
    Отправить ссылку на репозиторий с ролью и Declarative Pipeline и Scripted Pipeline.

### Решение 8
[Declarative Pipeline](pipeline%2FJenkinsfile)
[Scripted Pipeline](pipeline%2FScriptedJenkinsfile)
[Repo with my role](https://github.com/EfanRu/vector-role)

## Необязательная часть

### Задание 1
    Создать скрипт на groovy, который будет собирать все Job, завершившиеся хотя бы раз неуспешно. Добавить скрипт в репозиторий с решением и названием AllJobFailure.groovy.

### Решение 1
    Не сделано.

### Задание 2
    Создать Scripted Pipeline так, чтобы он мог сначала запустить через Yandex Cloud CLI необходимое количество 
    инстансов, прописать их в инвентори плейбука и после этого запускать плейбук. Мы должны при нажатии кнопки 
    получить готовую к использованию систему.

### Решение 2
    Не сделано.

---